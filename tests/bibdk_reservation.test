<?php

/**
 * Test validation of fields and form submission
 */
class BibdkReservationButtonTestCase extends DrupalWebTestCase {

  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Reservation button and infotexts'),
      'description' => t('Test if button is present on the right manifistations'),
      'group' => t('Reservation'),
    );
  }

  public function setUp() {
    //$this->profile = 'bibdk';
    //parent::setUp('bibdk_reservation', 'ting', 'ding_entity', 'ting_openformat', 'devel');
    parent::setup();
    ;
    variable_set('clean_url', 1);
    variable_set('ting_agency', '100200');

// TODO: Change link to muckup URL 
    variable_set('ting_search_url', 'http://lakiseks.dbc.dk/hive/');
  }

  public function testButtonsExists() {
    $this->drupalGet('/work/870970-basis%3A28960115');
    $this->assertFieldByName("op", "Order any edition", "Manifestation Reservation Button Exists");
    $this->assertFieldByName("op", "Order this Lydbog (cd-mp3)", "SubWork Reservation Button Exists");
  }

  public function testButtonIsMissing() {
    $this->drupalGet('/work/870970-basis:04727061');
    $this->assertText('870970-basis:04727061', "Page could be found");
    $this->assertTrue('Order this', "No Button Present on Manifestation");
    $this->assertTrue('Order any edition', "No Button Present on Subwork");
  }

  public function infoTextIsPresent() {
    $this->drupalGet('/work/870970-basis:25699815');
    $this->assertText('870970-basis:25699815', "Page could be found");
    $this->assertTrue('drupal_text_oldSBTB', "Infotext is present");
  }

  public function LinkIsPresent() {
    $this->drupalGet('/work/870970-basis:23108283');
    $this->assertText('870970-basis:23108283', "Page could be found");
    $this->assertTrue('Insert link here', "Link is present");
  }

}

class BibdkReservationFlow extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Step 1 - 6 : User input and reservation',
      'description' => t('Test OpenAgency ServiceRequest & form submission'),
      'group' => 'Reservation',
    );
  }

  public function setUp() {
    //parent::setUp();
    $this->profile = 'bibdk';
    
     parent::setup(array('bibdk_reservation',
      'bibdk_vejviser',
      'bibdk_openorder',
      'bibdk_openorder_webservice_mockup',
      'ting_openformat',
      'ting_openformat_webservice_mockup',
      'openagency_webservice_mockup',
      'bibdk_borchk_webservice_mockup',
      'devel'));
    $user = $this->drupalCreateUser(array('access devel information'));
    $this->drupalLogin($user);

    global $base_url;
    variable_set('agency_search_url', $base_url . '/openagency_webservice/');
    #variable_set('agency_search_url', 'http://guesstimate.dbc.dk/~fvs/OpenLibrary/OpenAgency/trunk/'); //Live service

    variable_set('bibdk_borchk_url', $base_url . '/bibdk_borchk_webservice/');
    variable_set('bibdk_borchk_servicerequester', 'bibliotek.dk');
    variable_set('bibdk_openorder_url', $base_url . '/bibdk_openorder_webservice/');
    variable_set('bibdk_openorder_groupIdAut', '010100');
    variable_set('bibdk_openorder_passwordAut', '20Koster');
    variable_set('bibdk_openorder_userIdAut', 'netpunkt');
    variable_set('bibdk_openorder_serviceRequester', '190101');
    variable_set('bibdk_openorder_verification_reference_source', 'dbcdatawell');

    variable_set('ting_agency', '100200');
    variable_set('ting_search_profile', 'test');
    variable_set('ting_search_openformat', 'bibliotekdkWorkDisplay');

    // TODO: Change link to muckup URL 
    variable_set('ting_search_url', 'http://lakiseks.dbc.dk/hive/');
  }

  public function testMultiStepReservationForm() {

    /* STEP 0 */
    $this->drupalGet('reservation', array('query' => array('ids' => '870971-tsart%3A86167743')));
    // TODO : Test That new session is created 
    // TODO : Check that flow stops if no manifestation is selected

    /* STEP 1 */
    $this->assertField('anyField', "Agency Field \"anyField\" exists");
    $this->drupalPost(NULL, NULL, t('Next'));
    $this->assertText(t('You haven\'t entered any search criteria.'), t('"No input" Error message appears correctly'));

    /* STEP 2 */
    $this->drupalPost(NULL, array('anyField' => 'als'), t('Next'));
    $this->assertText('Als Bibliotek', t('Agency search result correctly shown'));
    $this->assertFieldById('edit-button', t('Select'), 'Select button is present');

    /* STEP 3 */
    //Check if fields exist
    $this->drupalPost(NULL, NULL, t('Select'));
    $this->assertTitle('Add Personal Data', 'We are on step 3!');
    $this->assertField("cpr", "Field CPR-number exists");
    $this->assertField("pincode", "Field pincode exists");
    $this->assertField("userName", "Field userName exists");

    $this->drupalPost(NULL, NULL, t('Next'));

    //Check if required elements is set
    $this->assertText('Name field is required');
    $this->assertText('CPR-number field is required');
    $this->assertText('Pincode field is required');
    $this->assertText('Adress, postal code, town/city field is required');

    // Check if OrderParameters are required
    $this->assertText('issue field is required.');
    $this->assertText('publicationDateOfComponent field is required.');

    //Check custom validation
    $this->drupalPost(NULL, array('pincode' => '123123123', 'userMail' => "qwqwqw@weewewe"), t('Next'));
    $this->assertText(t('Pincode needs to be a four diggit number'));
    $this->assertText(t('Email needs to be a valid email'));
    $this->drupalPost(NULL, array(
      'cpr' => '1234561234',
      'pincode' => '1231',
      'userMail' => 'test@test.dk',
      'userName' => 'Test Testersen',
      'userAddress' => 'testing 5',
      'issue' => 'test Issue',
      'publicationDateOfComponent' => 'test publicationDateOfComponent'
        ), "Next");

    //Check if validation passes
    $this->assertNoText('Name field is required');
    $this->assertNoText('User ID field is required');
    $this->assertNoText('Pincode field is required');
    $this->assertNoText('Adress, postal code, town/city field is required');
    $this->assertNoText('Pincode needs to be a four diggit number');
    $this->assertNoText('CPR-number needs to be a valid CPR-number');
    $this->assertNoText('Email needs to be a valid email');
    $this->assertNoText('issue field is required.');
    $this->assertNoText('publicationDateOfComponent field is required.');

    //Test Bad user
    $this->assertText('User not found');

    //Test Good user
    $this->drupalPost(NULL, array(
      'cpr' => '0019',
      'pincode' => '0019',
      'userName' => 'Test Testersen',
      'userAddress' => 'testing 5',
      'userMail' => 'test@test.dk',
      'needBeforeDate[month]' => 12,
      'needBeforeDate[year]' => 2012,
      'needBeforeDate[day]' => 10,
      'issue' => 'test Issue',
      'publicationDateOfComponent' => 'test publicationDateOfComponent'
        ), t('Next'));
    $this->assertNoText('User not found');

    /* STEP 4 */
    $this->assertText('CPR-number: ****');
    $this->assertText('Name: Test Testersen');
    $this->assertText('Adress, postal code, town/city: testing 5');
    $this->assertText('E-mail: test@test.dk');
    $this->assertText('Need before Date: 10/12/2012');
    $this->assertText('test Issue');
    $this->assertText('test publicationDateOfComponent');
    $this->assertText('Als Bibliotek');
    $this->assertText('Danske økologer vil dyrke sojabønner.');

    /* STEP 5 */
    $this->drupalPost(NULL, NULL, t('Order'));
    $this->assertText('1009323660');
    
    #$this->_testReBorrow();

    /* CheckOrderPolicy */
    $this->_testCheckOrderPolicy();

    /* This test is not working */
    //$this->_testFavouriteLibrary();
  }

  private function _testCheckOrderPolicy() {

    // Material cannot be borrowed
    $this->drupalGet('reservation', array('query' => array('ids' => '870970-basis:28794932')));
    $this->drupalPost(NULL, array('anyField' => 'odense'), t('Next'));
    $this->assertText('Odense Centralbibliotek', t('Agency search result correctly shown'));
    $this->drupalPost(NULL, NULL, t('Select'));
    $this->assertText('The material cannot be borrowed through bibliotek.dk');

    // Material can be borrowed
    $this->drupalGet('reservation', array('query' => array('ids' => '870971-tsart%3A86167743')));
    $this->drupalPost(NULL, array('anyField' => 'als'), t('Next'));
    $this->assertText('Als', t('Agency search result correctly shown'));
    $this->drupalPost(NULL, NULL, t('Select'));
    $this->assertNoText('The material cannot be borrowed through bibliotek.dk');
  }

  private function _testFavouriteLibrary() {
    // THIS IS NOT WORKING :(

    $session['bibdk_favourites'] = array('this is true');
    $user = $this->drupalCreateUser(array('access devel information'));
    $user->session = serialize($session);
    $this->drupalLogin($user);

    // Material cannot be borrowed
    $this->drupalGet('reservation', array('query' => array('ids' => '870971-tsart%3A86167743')));
    $this->assertTitle('Add Personal Data | Bibliotek.dk');
  }

}
