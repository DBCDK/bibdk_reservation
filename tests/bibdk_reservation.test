<?php

/**
* Test validation of fields and form submission
*/
class BibdkReservationButtonTestCase extends DrupalWebTestCase {
 
/**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array (
      'name' => t('Reservation button and infotexts'),
      'description' => t('Test if button is present on the right manifistations'),
      'group' => t('Reservation'),
    );
  }
  public function setUp() {
    $this->profile = 'bibdk';
    parent::setUp('bibdk_reservation', 'ting', 'ding_entity', 'ting_openformat');
    variable_set('clean_url', 1);
    variable_set('ting_agency', '100200');
    // TODO: Change link to muckup URL 
    variable_set('ting_search_url', 'http://lakiseks.dbc.dk/hive/'); 
  }
  
  public function testButtonsExists(){
     $this->drupalGet('/work/870970-basis%3A28960115');
     $this->assertFieldByName("op", "Order any edition","Manifestation Reservation Button Exists");
     $this->assertFieldByName("op", "Order this Lydbog (cd-mp3)","SubWork Reservation Button Exists");
  }
   
  public function testButtonIsMissing(){
    $this->drupalGet('/work/870970-basis:04727061');
    $this->assertText('870970-basis:04727061', "Page could be found");
    $this->assertTrue('Order this', "No Button Present on Manifestation");
    $this->assertTrue('Order any edition', "No Button Present on Subwork");
  }
  
  public function infoTextIsPresent(){
    $this->drupalGet('/work/870970-basis:25699815');
    $this->assertText('870970-basis:25699815', "Page could be found");
    $this->assertTrue('drupal_text_oldSBTB', "Infotext is present");
  }
  
  public function LinkIsPresent(){
    $this->drupalGet('/work/870970-basis:23108283');
    $this->assertText('870970-basis:23108283', "Page could be found");
    $this->assertTrue('Insert link here', "Link is present");
  }
  
}


class BibdkReservationStep3 extends DrupalWebTestCase {
  
  public static function getInfo() {
    return array(
      'name' => 'Step 3 : User input',
      'description' => t('Test OpenAgency ServiceRequest & form submission'),
      'group' => 'Reservation',
    );
  }
  
  public function setUp() {
    $this->profile = 'bibdk';
    parent::setup(array('bibdk_reservation', 'openagency_webservice_mockup', 'ting'));
  }


  public function testServiceRequest() {
    $url = variable_get('agency_search_url');
    $this->assertNull($url, 'No URL set for Open Agency yet');
    global $base_url;
    variable_set('agency_search_url', $base_url.'/openagency_webservice/');
    $newUrl = variable_get('agency_search_url');
    $this->assertNotNull($newUrl, 'URL to mockup set: ' . $newUrl);

    $xml = '<?xml version="1.0" encoding="UTF-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"><SOAP-ENV:Body><serviceRequest><agencyId>DK-810010</agencyId><service>userOrderParameters</service><outputType>xml</outputType></serviceRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>';
    $this->drupalPost('openagency_webservice_test', array('xml' => $xml), t('submit'));
    $this->assertText('userId', t('Mockup Agency serviceRequest passes'));
  }
  
  public function testStep3FormFields (){
    $this->drupalPost("reservation", NULL, "Next");
    $this->drupalPost("reservation", NULL, "Next");
    $this->drupalPost('reservation', NULL, "Next");
  }
}
